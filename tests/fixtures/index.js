"use strict";var f=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var T=(e,t)=>{for(var n in t)f(e,n,{get:t[n],enumerable:!0})},P=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of M(t))!L.call(e,s)&&s!==n&&f(e,s,{get:()=>t[s],enumerable:!(o=C(t,s))||o.enumerable});return e};var I=e=>P(f({},"__esModule",{value:!0}),e);var j={};T(j,{captureError:()=>u,config:()=>m,load:()=>k,track:()=>c});module.exports=I(j);var a={DEBUG_FLAG:"upassist_rum_debug",TRACKING_ENABLED:"upassist_rum_enable",TRACKING_DISABLED:"upassist_rum_disable",SESSION_COOKIE:"_up_session_id"};var g=e=>window&&window.location.search.indexOf(e)>-1,w=()=>{let e=g(a.TRACKING_ENABLED),t=g(a.TRACKING_DISABLED);if(e||t){if(!window.localStorage){r("Can't disable Upassist RUM. This browser does not support local storage.",void 0,!0);return}e&&(window.localStorage.removeItem(a.TRACKING_DISABLED),r("Upassist RUM has been enabled on this device.",void 0,!0)),t&&(window.localStorage.setItem(a.TRACKING_DISABLED,"true"),r("Upassist RUM has been disabled on this device.",void 0,!0))}},U=()=>{if(window.history.pushState&&!window.upassist._historyPatched){r("Single page app mode is set to 'history', patching History API");let e=window.history.pushState,t=()=>c("Pageview");window.history.pushState=function(){e.apply(this,arguments),t()},window.addEventListener("popstate",t),window.upassist._historyPatched=!0,r("Listening for History API changes")}},r=(e,t,n)=>{let o=i.debug||g(a.DEBUG_FLAG);if(!n&&!o)return;let s=`[Upassist RUM] ${e}`;t?console.log(s,t):console.log(s)};var i={ingestionHost:"https://rum.upassist.cloud/api",honorDNT:!1,filterLocalhost:!1,debug:!1,trackMode:"history",enabled:!0,autoTrackErrors:!0,autoTrackCoreWebVitals:!0},v=e=>(i={...i,...e},r("Updated configuration",i),i);var p=require("typescript-cookie"),b=require("uuid");function h(e,t){return{client_key:i.clientKey,environment:i.environment,event_name:e,user_agent:A(),url:x(),referrer:F(),language:N(),connection_type:D(),screen_width:B(),timezone:G(),session_id:W(),...O(),...V(e),...t||{}}}var x=()=>{let e=i.includeURLFragment?window.location.hash:"",t=[];if(i.includeURLQueryParams&&i.includeURLQueryParams.length>0){let o=new URLSearchParams(window.location.search);for(let s of i.includeURLQueryParams)if(o.has(s)){let _=o.get(s);_?t.push(`${s}=${_}`):t.push(`${s}`)}}let n="";return t&&t.length>0&&(n=`?${t.join("&")}`),window.location.protocol+"//"+window.location.hostname+window.location.pathname+n+e},A=()=>window.navigator.userAgent,l=e=>{let t=window.location.search.match(e);return t?t[2]:void 0},O=()=>({utm_source:l(/[?&](ref|source|utm_source)=([^?&]+)/),utm_campaign:l(/[?&](utm_campaign)=([^?&]+)/),utm_medium:l(/[?&](utm_medium)=([^?&]+)/),utm_content:l(/[?&](utm_content)=([^?&]+)/),utm_term:l(/[?&](utm_term)=([^?&]+)/)}),N=()=>{let e=window.navigator;return e?e.userLanguage||e.language:void 0},G=()=>{try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch{return}},D=()=>navigator.connection&&"effectiveType"in navigator.connection?navigator.connection.effectiveType:void 0,F=()=>{let e=document.referrer;if(e){let t=new URL(e);return t.hostname.toLowerCase()===window.location.hostname.toLowerCase()?void 0:t.protocol+"//"+t.hostname+t.pathname}},B=()=>window==null?void 0:window.innerWidth,K=e=>{try{if(e){let t=Math.ceil(e);return isNaN(t)||t<0?void 0:t}else return}catch{return}},W=()=>{let e=(0,p.getCookie)(a.SESSION_COOKIE);if(!e){r("Session is not found, creating new one");let t=new Date;t.setMinutes(t.getMinutes()+30);let n=(0,b.v4)();return(0,p.setCookie)(a.SESSION_COOKIE,n,{expires:t}),n}return e},V=e=>{let t={};if(e!=="Pageview"||window.upassist._initialPageLoadSent)return t;try{let n=window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance||{};if(n.getEntriesByType){let o=n.getEntriesByType("navigation")[0];o&&(t={page_load_dns:o.domainLookupEnd-o.domainLookupStart,page_load_connect:o.connectEnd-o.connectStart,page_load_ssl:o.secureConnectionStart?o.requestStart-o.secureConnectionStart:void 0,page_load_ttfb:o.responseStart-o.requestStart,page_load_download:o.responseEnd-o.responseStart,page_load_dom_content_loaded:o.domContentLoadedEventEnd-o.responseEnd,page_load_render:o.domComplete-o.domContentLoadedEventEnd,page_load_total:o.loadEventStart,page_load_transfer_size:o.transferSize})}}catch(n){r("Error while loading performance metrics",n)}for(let n of Object.keys(t))t[n]=K(t[n]);return window.upassist._initialPageLoadSent=!0,t};var y=async(e,t)=>{let n=h(e,t),o=H(n);o&&z(o)&&await $(o)},$=async e=>{let t=`${i.ingestionHost}/sites/events`,n=JSON.stringify(e);navigator.sendBeacon?navigator.sendBeacon.call(navigator,t,n):await fetch(t,{body:n,method:"POST",credentials:"omit",keepalive:!0}),r("Sent events",e)},z=e=>{if(!i.clientKey)return r("Bad configuration: missing clientKey",void 0,!0),!1;if(!e.event_name||!/^[a-zA-Z][a-zA-Z0-9\_\-\.]{0,63}$/.test(e.event_name)){r("Invalid event name.",void 0,!0);return}if(window.localStorage&&window.localStorage.getItem(a.TRACKING_DISABLED)||!i.enabled)return r("Skipping event collection, Upassist RUM has been manually disabled on this browser.",void 0,!0),!1;if(!i.debug){if(i.honorDNT&&"doNotTrack"in window.navigator&&window.navigator.doNotTrack==="1")return r("Honoring 'Do Not Track'",void 0,!0),!1;if(i.filterLocalhost&&/^localhost$|^127(?:\.[0-9]+){0,2}\.[0-9]+$|^(?:0*\:)*?:?0*1$/.test(window.location.hostname))return r("Skipping event collection, localhost filter enabled",void 0,!0),!1;if(window.location.protocol==="file:")return r("Can't track from file URLs",void 0,!0),!1;if(window.document.visibilityState==="prerender")return r("Skipping event collection, document is pre-rendering",void 0,!0),!1;if(window.navigator.webdriver)return r("Skipping event collection, navigation is automated",void 0,!0),!1}if(e.event_name==="Pageview"){let t=window.upassist._previousPath,n=e.url;if(window.upassist._previousPath=n,t&&t===n){r("Skipping event collection, duplicate pageview detected");return}}return!0},H=e=>{let t=e;if(i.beforeSend){let n;try{n=i.beforeSend({...e})}catch(o){console.error(o)}if(!n){r("beforeSend hook returned null or undefined, skipping event collection");return}n.client_key=e.client_key;for(let o of Object.keys(e))t[o]=n[o]}return t};function E(e,t){let n=!1;return(...o)=>{n||(n=!0,setTimeout(()=>{e(...o),n=!1},t))}}var d=require("web-vitals");function R(){var e;(e=window==null?void 0:window.upassist)!=null&&e._listeningForErrors||(window.addEventListener("error",u),window.upassist._listeningForErrors=!0,r("Listening for errors"))}function S(){var t;if((t=window==null?void 0:window.upassist)!=null&&t._listeningForCoreWebVitals)return;let e=(n,o)=>s=>{c(n,{[o]:s.value})};(0,d.onCLS)(e("WebVital","web_vital_cls")),(0,d.onFID)(e("WebVital","web_vital_fid")),(0,d.onLCP)(e("WebVital","web_vital_lcp")),window.upassist._listeningForCoreWebVitals=!0,r("Listening for Core Web Vitals")}var q=(e,t,n={})=>{switch(e){case"config":if(!t)return r("Passed empty config params");m(t);break;case"track":c(t,n);break;case"captureError":u(t,n);break;default:r("Unknown command",e,!0);return}},u=E((e,t={})=>{var n,o;c("Error",{error_type:((n=e.error)==null?void 0:n.name)||"Error",message:((o=e.error)==null?void 0:o.message)||e.message,lineno:e.lineno,colno:e.colno,filename:e.filename,...t})},1e3),c=(e,t={})=>{let n=()=>y(e,t);document.readyState==="complete"?setTimeout(n,0):(r("Document not ready, adding event listener"),window.addEventListener("load",()=>{setTimeout(n,0)}))},m=e=>{let t={...i},n=v(e);i.trackMode&&["pageload","history"].indexOf(i.trackMode)>-1&&(i.trackMode==="history"&&U(),!t.clientKey&&n.clientKey&&(r("Triggering initial pageview"),c("Pageview"))),r(`Tracking mode: ${i.trackMode}`)},k=(e,t)=>{m({clientKey:e,trackMode:"off",...t}),Q()},Q=()=>{w();let e=window.upassist&&window.upassist.q||[];window.upassist=q,window.upassist.q=e;for(let t of e)window.upassist.apply(void 0,t);i.autoTrackErrors&&R(),i.autoTrackCoreWebVitals&&S()};0&&(module.exports={captureError,config,load,track});
